<!DOCTYPE html>

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1, minimum-scale=1.0, user-scalable=no" name="viewport" />
  <meta name="theme-color" content="white" />
  <link rel="manifest" href="manifest.json">
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
  <style>
    @font-face {
      font-family: 'Roboto';
      font-style: normal;
      font-weight: 400;
      src: url(font.woff2) format('woff2');
    }

    * {
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      font-size: 14px;
      line-height: 20px;
      margin: 0;
      overflow: hidden;
    }

    .table-container {
      overflow: scroll;
      overscroll-behavior: contain;
      width: 100%;
      height: 704px;
      background-color: #fff;
    }

    .table {
      width: 100%;
      margin-top: 10px;
      height: max-content;
      border-spacing: 0px;
    }

    .table td {
      height: 42px;
      border-top: 0.2px solid #000;
      border-bottom: 0.2px solid #000;
    }

    .date-row {
      width: 82px;
      font-size: 17px;
      text-align: right;
    }

    .table-subjects {
      width: 100%;
      display: flex;
      justify-content: space-evenly;
    }

    .subjects-row {
      height: 100%;
      width: 17%;
      border: none;
      font-size: 18px;
      padding: 0px;
      text-align: center;
      border-radius: 0;
    }

    .table-afterschool {
      width: 100%;
      display: flex;
      justify-content: space-evenly;
      align-items: center;
    }

    .table-afterschool>div {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 60px;
      height: 100%;
    }

    .table-afterschool>div>input {
      opacity: 0;
      position: absolute;
      width: 100%;
      height: 100%;
    }

    .table-afterschool>div>label:first-of-type {
      font-size: 31px;
    }

    .table-afterschool>div>label:last-of-type {
      position: absolute;
      font-size: 33px;
      pointer-events: none;
      display: flex;
      align-items: center;
      padding-top: 4px;
      font-weight: bold;
      color: red;
      height: 100%;
      clip-path: inset(0 100% 0 0);
      transition: 0.1s cubic-bezier(0.37, 0, 0.63, 1);
      transition-property: clip-path;
    }

    .table-afterschool>input:nth-child(2) {
      width: 100px;
      font-size: 20px;
    }

    .table-button:has(input:checked)>label:last-of-type {
      clip-path: inset(0) !important;
    }


    .form {
      position: fixed;
      width: 100%;
      font-size: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .radio {
      width: 90%;
      border: 0.8px solid #b6b6b6;
    }

    .radio>div {
      display: flex;
      justify-content: space-around;
    }

    .radio>div>div {
      height: 50px;
      width: 100%;
      position: relative;
    }

    .radio>div>div>input {
      width: 100%;
      height: 100%;
      opacity: 0;
    }

    .radio>div>div>input:checked+label {
      background: #d81b60;
      font-weight: 700;
      color: #fff;
    }

    .radio>div>div>label {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      border: 0.8px solid #b6b6b6;
    }

    .other {
      width: 90%;
      margin-top: 1.5vh;
      font-size: 18px;
    }

    .other2 {
      width: 90%;
      font-size: 18px;
    }

    .submit {
      display: flex;
      justify-content: center;
      align-items: center;
      background: #fff;
      border: 1px solid #b6b6b6;
      width: 90%;
      height: 40px;
      margin-top: 6vh;
      font-size: 16px;
      text-decoration: none;
      position: relative;
      transition-duration: 0.05s;
    }

    .submit:active {
      background: #d81b60;
      font-weight: 700;
      color: #fff;
    }


    .calendar-div {
      width: 100%;
      height: 700px;
      position: fixed;
      font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
      font-size: 13px;
    }

    #calendar-container {
      position: absolute;
      top: 2%;
      left: 8px;
      right: 8px;
      bottom: 10%;
    }

    .fc-header-toolbar {
      font-size: 10px;
    }

    .fc-scroller {
      overscroll-behavior: contain;
    }

    .fc-button-group>.fc-button:not(.fc-button-active),
    .fc-today-button:not(:disabled) {
      color: #000 !important;
      background-color: #fff !important;
      border-color: #000 !important;
    }

    .fc-button-group>.fc-button-active {
      color: #fff !important;
      background-color: #000 !important;
      border-color: #000 !important;
    }

    .cl-bt {
      width: 100%;
      position: relative;
      bottom: -643px;
      text-align: center;
      z-index: 9997;
    }

    .tab {
      display: inline-block;
      font-size: 15px;
      text-align: center;
      cursor: pointer;
      background: #fff;
      color: #000;
      padding-left: 15px;
      padding-right: 15px;
      padding-top: 10px;
      padding-bottom: 10px;
      border: 1px solid #000;
    }

    .fc .fc-non-business,
    .fc .fc-bg-event {
      background-color: #c0f2bd;
      opacity: .3;
    }

    #todo>tr>th {
      height: 30px;
      text-align: left;
      padding-left: 30px;
      color: #fff;
      background-color: #000;
    }

    #todo>tr>td {
      height: 37px;
    }

    #todo>tr>td:nth-child(1) {
      width: 40px;
      font-size: 30px;
      padding-bottom: 5px;
      text-align: center;
    }

    #todo>tr>td:nth-child(3),
    #todo>tr>td:nth-child(4) {
      width: 67px;
      font-size: 12px;
      font-family: "Roboto";
      padding-right: 20px;
      text-align: right;
    }

    .already {
      text-decoration: line-through;
    }

    .studyplus {
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 55px;
      height: 55px;
      color: #fff;
      font-size: 35px;
      background: #0096f8;
      text-decoration: none;
      text-align: center;
      position: fixed;
      bottom: 115px;
      right: 20px;
      box-shadow: 1px 2px 5px #666666;
    }



    .menu-buttons {
      position: fixed;
      bottom: 0px;
      display: flex;
      width: 100%;
      margin-top: 0px;
      padding-top: 0px;
      padding-right: 0px;
      padding-bottom: 0px;
      justify-content: space-around;
      z-index: 9999;
    }

    .menu-button {
      display: block;
      width: 100%;
      border-top: 1px solid #000;
      background-color: #d6d6d6;
      text-align: center;
    }

    .menu-text {
      margin-bottom: 40px;
      font-size: 10px;
      line-height: 13px;
    }

    .menu-icon {
      width: 27px;
      margin-top: 7px;
    }

    #select-form {
      width: 100%;
      position: fixed;
      top: 640px;
      display: flex;
      justify-content: space-evenly;
      z-index: 9998;
    }
  </style>
</head>

<body>

  <div class="table-container" id="timetable-container" style="display: none;">
    <table class="table">
      <tbody id="timetable">
      </tbody>
    </table>
  </div>


  <div class="table-container" id="afterschool-container" style="display: none;">
    <table class="table">
      <tbody id="afterschool">
      </tbody>
    </table>
  </div>


  <div class="table-container" id="todo-container" style="display: none;">
    <table class="table">
      <tbody id="todo">
      </tbody>
    </table>
    <a href='studyplus:///' class="studyplus">+</a>
  </div>



  <div class="form" id="homework">
    <div class="radio" style="margin-top: 7vh;">
      <div>
        <div><input type="radio" name="subject" checked><label>数II</label></div>
        <div><input type="radio" name="subject"><label>数B</label></div>
        <div><input type="radio" name="subject"><label>現文</label></div>
        <div><input type="radio" name="subject"><label>古典</label></div>
        <div><input type="radio" name="subject"><label>総英</label></div>
        <div><input type="radio" name="subject"><label>異理</label></div>
      </div>
      <div>
        <div><input type="radio" name="subject"><label>英表</label></div>
        <div><input type="radio" name="subject"><label>英表+</label></div>
        <div><input type="radio" name="subject"><label>物理</label></div>
        <div><input type="radio" name="subject"><label>化学</label></div>
        <div><input type="radio" name="subject"><label>世界史</label></div>
        <div><input type="radio" name="subject"><label>地理a</label></div>
      </div>
      <div>
        <div><input type="radio" name="subject"><label>地理b</label></div>
        <div><input type="radio" name="subject"><label>体育</label></div>
        <div><input type="radio" name="subject"><label>保健</label></div>
        <div><input type="radio" name="subject"><label>音楽</label></div>
        <div><input type="radio" name="subject"><label>家庭</label></div>
        <div><input type="radio" name="subject"><label>課</label></div>
      </div>
    </div>

    <div class="radio" style="margin-top: 6vh;">
      <div>
        <div><input type="radio" name="homework_content" checked><label>プリント</label></div>
        <div><input type="radio" name="homework_content"><label>ワーク</label></div>
        <div><input type="radio" name="homework_content"><label>その他</label></div>
      </div>
    </div>
    <input type="text" class="other" id="other_homework_content" placeholder="その他">

    <div class="radio" style="margin-top: 6vh;">
      <div>
        <div><input type="radio" name="homework_time"><label>0分</label></div>
        <div><input type="radio" name="homework_time"><label>15分</label></div>
        <div><input type="radio" name="homework_time" checked><label>30分</label></div>
        <div><input type="radio" name="homework_time"><label>45分</label></div>
        <div><input type="radio" name="homework_time"><label>60分</label></div>
        <div><input type="radio" name="homework_time"><label>その他</label></div>
      </div>
    </div>
    <input type="number" class="other" id="other_homework_time" placeholder="分" inputmode="numeric">

    <a class="submit" ontouchstart="" onclick="submit_homework()">Submit</a>
  </div>


  <div class="form" id="long" style="display: none;">
    <input type="text" class="other2" id="long_content" placeholder="内容" style="margin-top: 12vh;">
    <input type="number" class="other2" id="long_number" placeholder="問題数" style="margin-top: 6vh;" inputmode="numeric">

    <div class="radio" style="margin-top: 8vh;">
      <div>
        <div><input type="radio" name="long_time"><label>3分</label></div>
        <div><input type="radio" name="long_time" checked><label>5分</label></div>
        <div><input type="radio" name="long_time"><label>10分</label></div>
        <div><input type="radio" name="long_time"><label>その他</label></div>
      </div>
    </div>
    <input type="text" class="other" id="other_long_time" placeholder="その他" inputmode="numeric">

    <input type="date" class="other2" id="long_date" style="margin-top: 6vh; height: 34px; appearance: none;">

    <a class="submit" ontouchstart="" onclick="submit_long()">Submit</a>
  </div>


  <div class="form" id="short" style="display: none;">
    <input type="text" class="other2" id="short_content" placeholder="内容" style="margin-top: 12vh;">

    <div class="radio" style="margin-top: 10vh;">
      <div>
        <div><input type="radio" name="short_time"><label>0分</label></div>
        <div><input type="radio" name="short_time"><label>15分</label></div>
        <div><input type="radio" name="short_time" checked><label>30分</label></div>
        <div><input type="radio" name="short_time"><label>45分</label></div>
        <div><input type="radio" name="short_time"><label>60分</label></div>
        <div><input type="radio" name="short_time"><label>その他</label></div>
      </div>
    </div>
    <input type="text" class="other" id="other_short_time" placeholder="その他" inputmode="numeric">

    <input type="date" class="other2" id="short_date" style="margin-top: 8vh; height: 34px; appearance: none;">

    <a class="submit" ontouchstart="" onclick="submit_short()">Submit</a>
  </div>


  <div class="form" id="memory" style="display: none;">
    <div class="radio" style="margin-top: 12vh;">
      <div>
        <div><input type="radio" name="memory_content"><label>シス単</label></div>
        <div><input type="radio" name="memory_content"><label>必携</label></div>
        <div><input type="radio" name="memory_content"><label>漢字</label></div>
        <div><input type="radio" name="memory_content" checked><label>その他</label></div>
      </div>
    </div>
    <input type="text" class="other" id="other_memory_content" placeholder="その他">

    <input type="date" class="other2" id="memory_date" style="margin-top: 7vh; height: 34px; appearance: none;">
    <input type="number" class="other2" id="st_num" placeholder="開始番号" style="margin-top: 8vh;" inputmode="numeric">
    <input type="number" class="other2" id="en_num" placeholder="終了番号" style="margin-top: 3vh;" inputmode="numeric">

    <a class="submit" ontouchstart="" onclick="submit_memory()">Submit</a>
  </div>



  <div class="calendar-div" id="calendar-div" style="display: none;">
    <div id='calendar-container'>
      <div id='calendar'></div>
    </div>
    <div class="cl-bt">
      <a ontouchend="calendar.today()" class="tab">Today</a>
      <a id="month" ontouchend="change_cl('month')" class="tab">Month</a>
      <a id="4day" ontouchend="change_cl('4day')" class="tab" style="background-color: #000; color: #fff">4 Days</a>
    </div>
  </div>



  <div class="menu-buttons">
    <div class="menu-button" ontouchend="change_page('homework')">
      <img src="icon1.png"
        class="menu-icon">
      <div class="menu-text">宿題追加</div>
    </div>
    <div class="menu-button" ontouchend="change_page('todo-container')">
      <img src="icon2.png"
        class="menu-icon">
      <div class="menu-text">ToDo</div>
    </div>
    <div class="menu-button" ontouchend="change_page('calendar-div')">
      <img src="icon3.png"
        class="menu-icon">
      <div class="menu-text">calendar</div>
    </div>
    <div class="menu-button" ontouchend="change_page('timetable-container')">
      <img src="icon4.png"
        class="menu-icon">
      <div class="menu-text">時間割</div>
    </div>
    <div class="menu-button" ontouchend="change_page('afterschool-container')">
      <img src="icon5.png"
        class="menu-icon">
      <div class="menu-text">帰宅時間</div>
    </div>
  </div>

  <div id="select-form">
    <a id="homework-b" ontouchend="change_form('homework')" class="tab"
      style="color: #000; background-color: #0097ec">宿題</a>
    <a id="long-b" ontouchend="change_form('long')" class="tab">長期課題</a>
    <a id="short-b" ontouchend="change_form('short')" class="tab">短期課題</a>
    <a id="memory-b" ontouchend="change_form('memory')" class="tab">暗記</a>
  </div>


  <script>
    let CLIENT_ID, CLIENT_SECRET, API_KEY, REFRESH_TOKEN, SHEET_ID, HOMEWORK_CAL_ID, LONGWORK_CAL_ID, SHORTWORK_CAL_ID, CAL_ID, GAS_URL;
    let COLOR = ["#0097ec", "#a85eb3", "#00bd77", "#f4746b"];
    let holiday;


    const dbName = 'DB';
    const dbVersion = '1';
    const storeName = 'passwords';
    const openReq = indexedDB.open(dbName, dbVersion);
    openReq.onerror = function (event) {
      console.log('接続失敗');
    }

    openReq.onupgradeneeded = function (event) {
      var db = event.target.result;
      const objectStore = db.createObjectStore(storeName, { keyPath: 'id' })
      objectStore.createIndex("id", "id", { unique: true });
      objectStore.createIndex("cl", "cl", { unique: false });
      objectStore.createIndex("cs", "cs", { unique: false });
      objectStore.createIndex("api", "api", { unique: false });
      objectStore.createIndex("token", "token", { unique: false });
      objectStore.createIndex("sh", "sh", { unique: false });
      objectStore.createIndex("c1", "c1", { unique: false });
      objectStore.createIndex("c2", "c2", { unique: false });
      objectStore.createIndex("c3", "c3", { unique: false });
      objectStore.createIndex("c4", "c4", { unique: false });
      objectStore.createIndex("url", "url", { unique: false });
      console.log('DB更新');
    }

    openReq.onsuccess = function (event) {
      var db = event.target.result;
      var trans_g = db.transaction(storeName, 'readonly');
      var store_g = trans_g.objectStore(storeName);
      var getReq_g = store_g.get(1);

      getReq_g.onsuccess = function (event) {
        if (typeof event.target.result === 'undefined') {
          let input = window.prompt("keyを入力してください", "");
          let keys = input.split("$");
          var trans = db.transaction(storeName, "readwrite");
          var store = trans.objectStore(storeName);
          var putReq = store.put({
            id: 1,
            cl: keys[0],
            cs: keys[1],
            api: keys[2],
            token: keys[3],
            sh: keys[4],
            c1: keys[5],
            c2: keys[6],
            c3: keys[7],
            c4: keys[8],
            url: keys[9],
          });
          CLIENT_ID = keys[0];
          CLIENT_SECRET = keys[1];
          API_KEY = keys[2];
          REFRESH_TOKEN = keys[3];
          SHEET_ID = keys[4];
          HOMEWORK_CAL_ID = keys[5];
          LONGWORK_CAL_ID = keys[6];
          SHORTWORK_CAL_ID = keys[7];
          CAL_ID = keys[8];
          GAS_URL = keys[9];
        } else {
          let r = event.target.result;
          CLIENT_ID = r.cl;
          CLIENT_SECRET = r.cs;
          API_KEY = r.api;
          REFRESH_TOKEN = r.token;
          SHEET_ID = r.sh;
          HOMEWORK_CAL_ID = r.c1;
          LONGWORK_CAL_ID = r.c2;
          SHORTWORK_CAL_ID = r.c3;
          CAL_ID = r.c4;
          GAS_URL = r.url;
        }
        getdata();
      }
    }

    function deleteDB() {
      indexedDB.deleteDatabase(dbName);
      alert("削除しました");
    }

    let _token = {
      data: ["", new Date()],
      get: async function (func) {
        if (this.data[0] === "" || new Date().getTime() - this.data[1].getTime() > 59 * 60 * 1000) await get_access_token();
        func(this.data[0]);
      }
    }

    function encode(data) {
      let params = [];
      for (let name in data) params.push(encodeURIComponent(name) + '=' + encodeURIComponent(data[name]));
      return params.join('&').replace(/%20/g, '+');
    }

    function get_access_token() {
      return new Promise((r) => {
        let data = { client_id: CLIENT_ID, client_secret: CLIENT_SECRET, refresh_token: REFRESH_TOKEN, grant_type: "refresh_token" };
        let xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            _token.data = [JSON.parse(this.responseText).access_token, new Date()];
            r();
          }
        }
        xhr.open('POST', 'https://www.googleapis.com/oauth2/v4/token');
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.send(encode(data));
      });
    }

    function adddata(range, str, todo = false) {
      _token.get((token) => {
        let data = { "values": [[str]] }
        let xhr = new XMLHttpRequest();
        xhr.open('PUT', 'https://content-sheets.googleapis.com/v4/spreadsheets/' + SHEET_ID + '/values/' + range + '?valueInputOption=USER_ENTERED&alt=json&key=' + API_KEY);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('Authorization', 'Bearer ' + token);
        xhr.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            if (todo) edit_todo();
          }
        }
        xhr.send(JSON.stringify(data));
      });
    }

    function getdata() {
      _token.get((token) => {
        let xhr = new XMLHttpRequest();
        xhr.open('GET', 'https://content-sheets.googleapis.com/v4/spreadsheets/' + SHEET_ID + '/values/subject!A3%3AT?key=' + API_KEY);
        xhr.setRequestHeader('Authorization', 'Bearer ' + token);
        xhr.onload = () => {
          let data = JSON.parse(xhr.response).values;
          make_timetable(data);
          make_afterschool(data);
        };
        xhr.send();

        let flag = 0;

        let xhr2 = new XMLHttpRequest();
        xhr2.open('GET', 'https://content-sheets.googleapis.com/v4/spreadsheets/' + SHEET_ID + '/values/ToDo!A2%3AH?key=' + API_KEY);
        xhr2.setRequestHeader('Authorization', 'Bearer ' + token);
        xhr2.onload = () => {
          flag++;
        };
        xhr2.send();

        let xhr4 = new XMLHttpRequest();
        xhr4.open('GET', 'https://holidays-jp.github.io/api/v1/date.json');
        xhr4.onload = () => {
          let data = JSON.parse(xhr4.response),
            temp = [];
          for (let key in data) {
            temp.push({
              title: data[key],
              start: key,
              display: 'background',
              color: "#c0f2bd"
            });
          }
          holiday = temp;
          flag++;
        };
        xhr4.send();

        let xhr3 = new XMLHttpRequest();
        xhr3.open('GET', 'https://content-sheets.googleapis.com/v4/spreadsheets/' + SHEET_ID + '/values/daily!A2%3AC?key=' + API_KEY);
        xhr3.setRequestHeader('Authorization', 'Bearer ' + token);
        xhr3.onload = () => {
          let timerId = setInterval(() => {
            if (flag === 2) {
              clearInterval(timerId);
              make_todo(JSON.parse(xhr2.response).values, JSON.parse(xhr3.response).values);
            }
          }, 10);
        };
        xhr3.send();
      });
    }


    function today() {
      let date = new Date();
      date.setHours(date.getHours() - 4);
      return date;
    }


    let calendar;

    window.onload = function () {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register("/schedule/service-worker.js")
          .then(function (registration) {
            console.log("serviceWorker registed.");
          }).catch(function (error) {
            console.warn("serviceWorker error.", error);
          });
      }


      let calendarEl = document.getElementById('calendar'), drag = false, posi;

      calendar = new FullCalendar.Calendar(calendarEl, {
        timeZone: 'local',
        locale: 'ja',
        initialView: 'timeGridDay',
        views: {
          dayGridMonth: {
            titleFormat: {
              year: 'numeric',
              month: 'short'
            },
            dateClick: function (info) {
              change_cl('4day', false)
              calendar.changeView('timeGridDay', info.dateStr);
            },
            eventTimeFormat: function () { return '' },
            eventMouseEnter: function (info) {
              change_cl('4day', false)
              calendar.changeView('timeGridDay', info.event.start);
            }
          },
          timeGridDay: {
            type: 'timeGrid',
            duration: { days: 4 },
            titleFormat: {
              month: 'short',
              day: 'numeric'
            },
            slotLabelInterval: '01:00',
            slotLabelFormat: {
              hour: 'numeric',
              minute: '2-digit'
            }
          }
        },
        headerToolbar: {
          left: '',
          center: 'title',
          right: ''
        },
        height: '100%',
        slotDuration: '00:15',
        snapDuration: '00:05',
        expandRows: true,
        nowIndicator: true,
        eventShortHeight: 1,
        scrollTimeReset: false,
        scrollTime: (new Date().getHours() - 2) + ':00:00',
        dayCellContent: function (e) {
          e.dayNumberText = e.dayNumberText.replace('日', '');
        },
        longPressDelay: 300,
        eventLongPressDelay: 300,
        selectLongPressDelay: 300,
        eventResizeStart: function () {
          drag = true;
        },
        eventResize: function (info) {
          let end = info.event.end;
          let day = Math.floor((end - new Date(today().toLocaleDateString())) / (24 * 60 * 60 * 1000));
          let time = String(end.getHours()).padStart(2, "0") + ":" + String(end.getMinutes()).padStart(2, "0");
          adddata("subject!N" + (day + 3), time, true);
          document.getElementsByClassName("time")[day].value = time;
        },
        businessHours: {
          daysOfWeek: [1, 2, 3, 4, 5],
          startTime: '00:00',
          endTime: '24:00',
        },
      });

      calendar.render();

      let element = document.getElementsByClassName("fc-view-harness fc-view-harness-active")[0];
      element.addEventListener("touchstart", start_check);
      element.addEventListener("touchend", end_check);

      function start_check(event) {
        posi = {};
        posi.x = event.changedTouches[0].pageX;
        posi.y = event.changedTouches[0].pageY;
      }

      function end_check(event) {
        let dx = posi.x - event.changedTouches[0].pageX;
        let dy = posi.y - event.changedTouches[0].pageY;
        if (Math.abs(dx) > Math.abs(dy) && !drag) {
          if (dx > 30) calendar.next();
          else if (dx < -30) calendar.prev();
        }
        drag = false;
      }


      let date = new Date();
      let y = date.getFullYear();
      let m = (date.getMonth() + 1).toString().padStart(2, "0");
      let d = date.getDate().toString().padStart(2, "0");
      document.getElementById("long_date").value = y + "-" + m + "-" + d;
      document.getElementById("memory_date").value = y + "-" + m + "-" + d;

      date.setDate(date.getDate() + 7);
      y = date.getFullYear();
      m = (date.getMonth() + 1).toString().padStart(2, "0");
      d = date.getDate().toString().padStart(2, "0");
      document.getElementById("short_date").value = y + "-" + m + "-" + d;
    }


    let timetable;

    function make_timetable(data) {
      timetable = data;
      let tbody = document.getElementById("timetable");
      let ds = new Date(today().toLocaleDateString());
      let de = new Date(today().toLocaleDateString());
      de.setDate(de.getDate() + timetable.length);
      let week = ["(日)", "(月)", "(火)", "(水)", "(木)", "(金)", "(土)"];

      for (var i = 0; i < data.length; i++) {
        if (data[i][0] === "") continue;

        let tr = document.createElement('tr');

        let date = document.createElement('td');
        date.setAttribute("class", "date-row");
        date.innerText = data[i][0];
        if (~data[i][0].indexOf('土')) date.style = "color: deepskyblue;"
        if (~data[i][0].indexOf('日')) date.style = "color: red;"
        for (let ii = 0; ii < holiday.length; ii++) {
          let d2 = new Date(holiday[ii].start);
          if (ds <= d2 && d2 <= de) {
            if (data[i][0] === (d2.getMonth() + 1) + "/" + d2.getDate() + week[d2.getDay()]) {
              date.style = "color: red;";
              break;
            }
          }
        }
        tr.appendChild(date);

        let subjects = document.createElement('td');
        subjects.setAttribute("class", "table-subjects");
        for (var ii = 0; ii < 5; ii++) {
          let input = document.createElement('input');
          input.setAttribute("class", "subjects-row");
          input.setAttribute("onchange", "change_timetable(this)");
          input.type = "text";
          input.size = "4";
          input.id = ['c', 'd', 'e', 'f', 'g'][ii] + (i + 3);
          if (data[i][ii + 7] !== "" && data[i][ii + 7] !== undefined) {
            input.setAttribute("style", "background-color: #ffebcd;");
            if (data[i][ii + 7] === "N") input.value = "";
            else input.value = data[i][ii + 7];
          }
          else input.value = data[i][ii + 2];
          input.setAttribute("data-orig", data[i][ii + 2]);
          input.setAttribute("data-prev", input.value);
          subjects.appendChild(input);
        }
        if (i === 0) check_subject(subjects);
        tr.appendChild(subjects);
        tbody.appendChild(tr);
      }
    }

    function change_timetable(e) {
      let text = e.value;
      if (text === "") {
        e.style = "";
        e.value = e.dataset.orig;
      }
      else e.style = "background-color: #ffebcd;";
      let subjects = ['数II', '数B', '現文', '古典', '総英', '異理', '英表', '英表+', '物理', '化学', '世界史', '地理a', '地理b', '体育', '保健', '音楽', '家庭', '課'],
        prev = [e.dataset.prev, -1],
        offsety = Number(e.id.slice(1)) - 3,
        row = e.id[0],
        offsetx = row === "c" ? 15 : row === "d" ? 16 : row === "e" ? 17 : row === "f" ? 18 : 19,
        now = [e.value, -1];
      loop: for (let i = offsety + 1; i < timetable.length; i++) {
        for (let ii = 15; ii < timetable[i].length; ii++) {
          if (timetable[i][ii] === prev[0]) {
            prev = [prev[0], i];
            break loop;
          }
          else if (prev[0] === "総英" && timetable[i][ii] === "異理") {
            prev = ["異理", i];
            break loop;
          }
          else if (prev[0] === "異理" && timetable[i][ii] === "総英") {
            prev = ["総英", i];
            break loop;
          }
        }
      }
      timetable[offsety][offsetx] = e.value;
      loop: for (let i = offsety + 1; i < timetable.length; i++) {
        for (let ii = 15; ii < timetable[i].length; ii++) {
          if (timetable[i][ii] === now[0]) {
            now = [now[0], i];
            break loop;
          }
          else if (now[0] === "総英" && timetable[i][ii] === "異理") {
            now = ["異理", i];
            break loop;
          }
          else if (now[0] === "異理" && timetable[i][ii] === "総英") {
            now = ["総英", i];
            break loop;
          }
        }
      }
      e.dataset.prev = e.value;

      if (now[1] >= 0) {
        let offset = now[1],
          day = new Date(today().toLocaleDateString());
        day.setDate(day.getDate() + offset);
        day.setHours(day.getHours() + 9);
        let day2 = new Date(day);
        day2.setHours(day2.getHours() + 1);

        _token.get((token) => {
          let xhr = new XMLHttpRequest();
          xhr.open('GET', 'https://www.googleapis.com/calendar/v3/calendars/' + HOMEWORK_CAL_ID + '/events?key=' + API_KEY
            + '&timeMax=' + encodeURIComponent(day2.toISOString()) + '&timeMin=' + encodeURIComponent(day.toISOString()));
          xhr.setRequestHeader('Authorization', 'Bearer ' + token);
          xhr.onload = () => {
            let date = today(), event = {};
            date.setDate(date.getDate() + offsety);
            event.date1 = get_datestr(date);
            date.setDate(date.getDate() + 1);
            event.date2 = get_datestr(date);

            let data = JSON.parse(xhr.response).items;
            for (var i = 0; i < data.length; i++) {
              if (data[i].summary.includes(now[0])) addevent2(event, data[i].id);
            }
          };
          xhr.send();
        });
      }

      if (prev[1] >= 0) {
        let offset = offsety,
          day = new Date(today().toLocaleDateString());
        day.setDate(day.getDate() + offset);
        day.setHours(day.getHours() + 9);
        let day2 = new Date(day);
        day2.setHours(day2.getHours() + 1);

        _token.get((token) => {
          let xhr = new XMLHttpRequest();
          xhr.open('GET', 'https://www.googleapis.com/calendar/v3/calendars/' + HOMEWORK_CAL_ID + '/events?key=' + API_KEY
            + '&timeMax=' + encodeURIComponent(day2.toISOString()) + '&timeMin=' + encodeURIComponent(day.toISOString()));
          xhr.setRequestHeader('Authorization', 'Bearer ' + token);
          xhr.onload = () => {
            let date = today(), event = {};
            date.setDate(date.getDate() + prev[1]);
            event.date1 = get_datestr(date);
            date.setDate(date.getDate() + 1);
            event.date2 = get_datestr(date);

            let data = JSON.parse(xhr.response).items;
            for (var i = 0; i < data.length; i++) {
              if (data[i].summary.includes(prev[0])) addevent2(event, data[i].id);
            }
          };
          xhr.send();
        });
      }

      adddata("subject!" + e.id.replace('c', 'h').replace('d', 'i').replace('e', 'j').replace('f', 'k').replace('g', 'l'), text);

    }

    function check_subject(s) {
      let subjects = ['数II', '数B', '現文', '古典', '総英', '異理', '英表', '英表+', '物理', '化学', '世界史', '地理a', '地理b', '体育', '保健', '音楽', '家庭', '課'];
      let today_subjects = [];
      for (var i = 0; i < 5; i++) if (s.children[i].value !== " " && s.children[i].value !== "ㅤ" && s.children[i].value !== "　") today_subjects.push(s.children[i].value);
      let now = new Date();
      let time = [
        new Date(new Date().toLocaleDateString() + " 9:50"),
        new Date(new Date().toLocaleDateString() + " 11:10"),
        new Date(new Date().toLocaleDateString() + " 13:20"),
        new Date(new Date().toLocaleDateString() + " 14:30")
      ];
      let subject = -1;
      for (var i = 0; i < today_subjects.length; i++) {
        if (i === today_subjects.length - 1) subject = subjects.indexOf(today_subjects[i]);
        if (now < time[i]) {
          subject = subjects.indexOf(today_subjects[i]);
          break;
        }
      }
      if (subject >= 0) document.getElementsByName("subject")[subject].checked = true;
    }


    function make_afterschool(data) {
      let tbody = document.getElementById("afterschool");
      let ds = new Date(today().toLocaleDateString());
      let de = new Date(today().toLocaleDateString());
      de.setDate(de.getDate() + timetable.length);
      let week = ["(日)", "(月)", "(火)", "(水)", "(木)", "(金)", "(土)"];

      for (var i = 0; i < data.length; i++) {
        if (data[i][0] === "") continue;

        let tr = document.createElement('tr');

        let date = document.createElement('td');
        date.setAttribute("class", "date-row");
        date.innerText = data[i][0];
        if (~data[i][0].indexOf('土')) date.style = "color: deepskyblue;"
        if (~data[i][0].indexOf('日')) date.style = "color: red;"
        for (let ii = 0; ii < holiday.length; ii++) {
          let d2 = new Date(holiday[ii].start);
          if (ds <= d2 && d2 <= de) {
            if (data[i][0] === (d2.getMonth() + 1) + "/" + d2.getDate() + week[d2.getDay()]) {
              date.style = "color: red;";
              break;
            }
          }
        }
        tr.appendChild(date);


        let td = document.createElement('td');
        td.setAttribute("class", "table-afterschool")

        let div1 = document.createElement('div');
        div1.setAttribute("class", "table-button")
        div1.innerHTML = '<label style="padding-top: 2px;">📖</label><label>＼</label>';
        let cram = document.createElement('input');
        cram.setAttribute("onchange", "change_afterschool(this)")
        cram.type = "checkbox";
        cram.checked = data[i][12] === "TRUE";
        cram.id = "m" + (i + 3);
        div1.appendChild(cram);
        td.appendChild(div1);

        let time = document.createElement('input');
        time.setAttribute("onblur", "adddata('subject!' + this.id, this.value, true)")
        time.setAttribute("class", "time")
        time.type = "time";
        if (data[i][13]) {
          let time_str = data[i][13].length === 4 ? "0" + data[i][13] : data[i][13];
          time.value = time_str;
        }
        if (data[i][12] === "TRUE") time.style = "color: red;";
        time.id = "n" + (i + 3);
        td.appendChild(time);

        if (i < 14) {
          let offset = new Date(today().toDateString());
          offset.setDate(offset.getDate() + i);
          let start = new Date(offset.toLocaleDateString() + " 09:00");
          if (time.value === "") time.value = "18:00";
          let end = new Date(offset.toLocaleDateString() + " " + time.value);
          if (start.toTimeString() !== end.toTimeString()) {
            calendar.addEvent({
              title: (data[i][12] === "TRUE") ? "学校" : "学校+東進着",
              start: start,
              end: end,
              color: "#696969",
              editable: true,
              startEditable: false,
              eventStartEditable: false,
              durationEditable: true,
              display: 'block'
            });
          }
        }

        let div2 = document.createElement('div');
        div2.setAttribute("class", "table-button")
        div2.innerHTML = '<label style="padding-bottom: 3px;">🍙</label><label>＼</label>';
        let dinner = document.createElement('input');
        dinner.setAttribute("onchange", "adddata('subject!' + this.id, this.checked, true)")
        dinner.type = "checkbox";
        dinner.checked = data[i][14] === "TRUE";
        dinner.id = "o" + (i + 3);
        div2.appendChild(dinner);
        td.appendChild(div2);

        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }

    function change_afterschool(e) {
      if (e.checked) e.parentElement.parentElement.children[1].style = "color: red;";
      else e.parentElement.parentElement.children[1].style = "";
      adddata("subject!" + e.id, e.checked, true);
    }


    function make_todo(data, data2) {
      for (var i = 0; i < data2.length; i++) {
        calendar.addEvent({
          title: data2[i][0],
          start: new Date(data2[i][1]),
          end: new Date(data2[i][2]),
          color: "#696969",
          editable: false,
          display: 'block'
        });
      }
      for (var i = 0; i < holiday.length; i++) {
        calendar.addEvent(holiday[i]);
      }


      for (var i = 0; i < data.length; i++) {
        data[i].push(i);
        let start = new Date(data[i][6]);
        start.setHours(start.getHours() - 6);
        data[i].push(start.toLocaleDateString());
      }
      data.sort((a, b) => {
        if (a[9] !== b[9]) {
          return new Date(a[6]) - new Date(b[6]);
        } else {
          return ((a[2] !== a[4]) === (b[2] !== b[4])) ? 0 : (a[2] !== a[4]) ? -1 : 1;
        }
      });

      let day = new Date(0).toLocaleDateString();
      let tbody = document.getElementById("todo");
      for (var i = 0; i < data.length; i++) {
        if (data[i][0] === "") continue;

        let color;
        if (data[i][1] === "宿題") color = COLOR[0];
        else if (data[i][1] === "長期学習") color = COLOR[1];
        else if (data[i][1] === "短期学習") color = COLOR[2];

        calendar.addEvent({
          title: data[i][0],
          start: new Date(data[i][6]),
          end: new Date(data[i][7]),
          color: color,
          editable: false,
          display: 'block'
        });

        if (day !== data[i][9]) {
          day = data[i][9];
          let tr = document.createElement('tr');
          let th = document.createElement('th');
          th.setAttribute("colspan", "4");
          th.innerText = day;
          tr.appendChild(th);
          tbody.appendChild(tr);
        }

        let tr = document.createElement('tr');
        tr.setAttribute("data-i", data[i][8]);

        let td = document.createElement('td');
        td.innerText = "●";
        if (data[i][1] === "宿題") td.style.color = COLOR[0];
        else if (data[i][1] === "長期学習") td.style.color = COLOR[1];
        else if (data[i][1] === "短期学習") td.style.color = COLOR[2];
        tr.appendChild(td);

        td = document.createElement('td');
        td.innerText = data[i][0];
        tr.appendChild(td);

        td = document.createElement('td');
        td.innerText = data[i][5];
        tr.appendChild(td);

        td = document.createElement('td');
        td.innerText = data[i][4] + "/" + data[i][2];
        if (data[i][4] !== "0") td.style = "color: red";
        tr.appendChild(td);

        if (data[i][4] == data[i][2]) {
          tr.children[0].innerText = "";
          tr.setAttribute("class", "already");
        }

        tbody.appendChild(tr);
      }

      let elements = document.querySelectorAll("#todo>tr:has(td):not([class])"), posi2;
      for (var i = 0; i < elements.length; i++) {
        elements[i].addEventListener("touchstart", start_todo);
        elements[i].addEventListener("touchmove", move_todo);
        elements[i].addEventListener("touchend", end_todo);
      }
      elements = document.querySelectorAll("#todo>.already");
      for (var i = 0; i < elements.length; i++) {
        elements[i].addEventListener("touchstart", start_todo);
        elements[i].addEventListener("touchend", end_todo2);
      }

      function start_todo(event) {
        posi2 = {};
        posi2.x = event.changedTouches[0].pageX;
        posi2.y = event.changedTouches[0].pageY;
      }

      function move_todo(event) {
        let move = event.changedTouches[0].pageX - posi2.x;
        if (move <= -15) {
          document.getElementById("todo-container").style = "overflow-y: hidden;"
          this.style = "translate: " + move + "px";
        }
      }

      function end_todo(event) {
        event.preventDefault();
        document.getElementById("todo-container").style = "";
        let move = event.changedTouches[0].pageX - posi2.x;
        let movey = event.changedTouches[0].pageY - posi2.y;
        if (move > -15 && Math.abs(movey) < 2) {
          this.children[3].style = "color: red"
          let data_i;
          data.forEach(e => {
            if (e[8] === Number(this.dataset.i)) data_i = e;
          });
          let time = (data_i[1] === "長期学習") ? 1 : 5;
          let time2 = Number(this.children[3].innerText.split("/")[0]);
          if (time2 + time >= data_i[2]) {
            this.style = "translate: 0px";
            setTimeout(() => done(this), 1);
          }
          else {
            time3 = time2 + time;
            adddata("ToDo!E" + (Number(this.dataset.i) + 2), time3);
            this.children[3].innerText = time3 + "/" + data_i[2];
          }
        }
        else if (move > -50) this.style = "translate: 0px; transition: 0.3s;";
        else done(this);
      }

      function done(tr) {
        tr.style = "translate: -100%; transition: 0.3s;";

        let data_i;
        data.forEach(e => {
          if (e[8] === Number(tr.dataset.i)) data_i = e;
        });
        adddata("ToDo!E" + (Number(tr.dataset.i) + 2), data_i[2]);

        setTimeout(() => {
          let new_element = tr.cloneNode(true);
          new_element.style = "";
          new_element.setAttribute("class", "already");
          new_element.children[0].innerText = "";
          new_element.children[3].style = ""
          new_element.children[3].innerText = data_i[2] + "/" + data_i[2];
          new_element.addEventListener("touchstart", start_todo);
          new_element.addEventListener("touchend", end_todo2);

          let ele = tr;
          while (true) {
            let next = ele.nextSibling;
            if (next === null) break;
            if (next.children[0].tagName === "TH") break;
            if (next.className === "already" && Number(next.dataset.i) > Number(tr.dataset.i)) break;
            ele = next;
          }

          ele.after(new_element);
          tr.remove();
        }, 300);
      }

      function end_todo2(event) {
        event.preventDefault();
        let move = event.changedTouches[0].pageX - posi2.x;
        let movey = event.changedTouches[0].pageY - posi2.y;
        if (Math.abs(move) > 2 || Math.abs(movey) > 2) return;

        let data_i;
        data.forEach(e => {
          if (e[8] === Number(this.dataset.i)) data_i = e;
        });
        adddata("ToDo!E" + (Number(this.dataset.i) + 2), 0);

        let new_element = this.cloneNode(true);
        new_element.classList.remove("already");
        new_element.children[0].innerText = "●";
        new_element.children[3].innerText = "0/" + data_i[2];
        new_element.addEventListener("touchstart", start_todo);
        new_element.addEventListener("touchmove", move_todo);
        new_element.addEventListener("touchend", end_todo);

        let ele = this.previousSibling;
        while (true) {
          if (ele.children[0].tagName === "TH") break;
          if (ele.className !== "already" && Number(ele.dataset.i) < Number(this.dataset.i)) break;
          ele = ele.previousSibling;
        }

        ele.after(new_element);
        this.remove();
      }

    }



    function addevent(event, id) {
      _token.get((token) => {
        let data = {
          "summary": event.title,
          "start": {
            "date": event.date1,
            "timeZone": "Asia/Tokyo"
          },
          "end": {
            "date": event.date2,
            "timeZone": "Asia/Tokyo"
          },
          "description": event.desc
        }
        let xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://www.googleapis.com/calendar/v3/calendars/' + id + '/events?key=' + API_KEY);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('Authorization', 'Bearer ' + token);
        xhr.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) edit_todo();
        }
        xhr.send(JSON.stringify(data));
        alert("送信しました");
      });
    }

    function addevent2(date, id) {
      _token.get((token) => {
        let data = {
          "start": {
            "date": date.date1,
            "timeZone": "Asia/Tokyo"
          },
          "end": {
            "date": date.date2,
            "timeZone": "Asia/Tokyo"
          }
        }
        let xhr = new XMLHttpRequest();
        xhr.open('PATCH', 'https://www.googleapis.com/calendar/v3/calendars/' + HOMEWORK_CAL_ID + '/events/' + id + '?key=' + API_KEY);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('Authorization', 'Bearer ' + token);
        xhr.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) edit_todo();
        }
        xhr.send(JSON.stringify(data));
      });
    }

    function submit_homework() {
      if (get_val('homework_content')[0] === "削除") {
        deleteDB();
        return;
      }
      _token.get((token) => {
        let xhr4 = new XMLHttpRequest();
        xhr4.open('GET', 'https://content-sheets.googleapis.com/v4/spreadsheets/' + SHEET_ID + '/values/duration!D3%3AD?key=' + API_KEY);
        xhr4.setRequestHeader('Authorization', 'Bearer ' + token);
        xhr4.onload = () => {
          submit_homework2(JSON.parse(xhr4.response).values);
        };
        xhr4.send();
      });
    }

    function submit_homework2(val) {
      let event = {};
      let subject = get_val('subject');
      if (subject[0] == "総英" || subject[0] == "異理") {
        if (val[4][0] < val[5][0]) subject = ["総英", 4];
        else subject = ["異理", 5];
      }
      event.title = subject[0] + " " + get_val('homework_content')[0];

      let date = today();
      date.setDate(date.getDate() + Number(val[subject[1]][0]));
      event.date1 = get_datestr(date);
      date.setDate(date.getDate() + 1);
      event.date2 = get_datestr(date);

      let time_str = isInt(get_val('homework_time')[0].replace("分", ""), "時間");
      if (!time_str) return;
      event.desc = today().toLocaleDateString() + ", " + time_str + ", 0";
      addevent(event, HOMEWORK_CAL_ID);
    }

    function submit_long() {
      let event = {};
      event.title = document.getElementById("long_content").value;
      if (event.title === "") {
        alert("内容を入力してください");
        return;
      }
      let number_str = isInt(document.getElementById("long_number").value, "問題数");
      let time_str = isInt(get_val('long_time')[0].replace("分", ""), "時間");
      if (!number_str || !time_str || !set_date(event, "long_date")) return;
      event.desc = new Date().toLocaleDateString() + ", " + number_str + ", 0, " + time_str;
      addevent(event, LONGWORK_CAL_ID);
    }

    function submit_short() {
      let event = {};
      event.title = document.getElementById("short_content").value;
      if (event.title === "") {
        alert("内容を入力してください");
        return;
      }
      let time_str = isInt(get_val('short_time')[0].replace("分", ""), "時間");
      if (!time_str || !set_date(event, "short_date")) return;
      event.desc = new Date().toLocaleDateString() + ", " + time_str + ", 0";
      addevent(event, SHORTWORK_CAL_ID);
    }

    function submit_memory() {
      let title = get_val('memory_content')[0];
      if (title === "") {
        alert("内容を入力してください");
        return;
      }

      let date = document.getElementById("memory_date").value;
      if (date === "") {
        alert("日付を入力してください");
        return;
      }
      let judge = new Date(date);
      judge.setDate(judge.getDate() - 1);
      if (judge <= new Date()) {
        alert("2日後以降の日付を入力してください");
        return;
      }

      let st_str = isInt(document.getElementById("st_num").value, "開始番号");
      let en_str = isInt(document.getElementById("en_num").value, "終了番号");
      if (!st_str || !en_str) return;
      if (Number(en_str) <= Number(st_str)) {
        alert("終了番号は開始番号より大きくしてください");
        return;
      }

      let gap = Math.floor((new Date(date) - new Date(new Date().toDateString())) / 86400000) - 1;
      const URL = GAS_URL + "?c=false&t=" + title + "&s=" + st_str + "&e=" + en_str + "&g=" + gap;
      let xhr = new XMLHttpRequest();
      xhr.open('GET', URL);
      xhr.send();
    }


    function set_date(event, name) {
      event.date1 = document.getElementById(name).value;
      if (event.date1 === "") {
        alert("日付を入力してください");
        return false;
      }
      let date = new Date(event.date1);
      date.setDate(date.getDate() + 1);
      event.date2 = get_datestr(date);
      return true;
    }

    function isInt(str, err) {
      let st_num = Number(str);
      if (str === "" || !Number.isInteger(st_num)) {
        alert(err + "は整数で入力してください");
        return false;
      } else return str;
    }

    function get_datestr(date) {
      let y = date.getFullYear();
      let m = (date.getMonth() + 1).toString().padStart(2, "0");
      let d = date.getDate().toString().padStart(2, "0");
      return y + "-" + m + "-" + d;
    }

    function get_val(name) {
      let buttons = document.getElementsByName(name);
      for (let i = 0; i < buttons.length; i++) {
        if (buttons.item(i).checked) {
          let val = buttons.item(i).nextElementSibling.innerText;
          if (val === "その他") val = document.getElementById('other_' + name).value;
          return [val, i];
        }
      }
    }



    function change_page(id) {
      document.getElementById("timetable-container").style = "display: none;";
      document.getElementById("afterschool-container").style = "display: none;";
      document.getElementById("todo-container").style = "display: none;";
      document.getElementById("homework").style = "display: none;";
      document.getElementById("long").style = "display: none;";
      document.getElementById("short").style = "display: none;";
      document.getElementById("memory").style = "display: none;";
      document.getElementById("select-form").style = "display: none;";
      document.getElementById("calendar-div").style = "display: none;";
      document.getElementById(id).style = "";
      if (id === "calendar-div") calendar.render();
      if (id === "homework") {
        document.getElementById("homework-b").style = "color: #000; background-color: " + COLOR[0];
        document.getElementById("long-b").style = "";
        document.getElementById("short-b").style = "";
        document.getElementById("memory-b").style = "";
        document.getElementById("select-form").style = "";
      }
    }

    function change_form(id) {
      document.getElementById("homework").style = "display: none;";
      document.getElementById("long").style = "display: none;";
      document.getElementById("short").style = "display: none;";
      document.getElementById("memory").style = "display: none;";
      document.getElementById("homework-b").style = "";
      document.getElementById("long-b").style = "";
      document.getElementById("short-b").style = "";
      document.getElementById("memory-b").style = "";
      document.getElementById(id).style = "";
      let color;
      if (id === "homework") color = COLOR[0];
      else if (id === "long") color = COLOR[1];
      else if (id === "short") color = COLOR[2];
      else if (id === "memory") color = COLOR[3];
      document.getElementById(id + "-b").style = "color: #000; background-color: " + color;
    }

    function change_cl(id, flag = true) {
      if (flag) {
        if (id === "month") calendar.changeView('dayGridMonth');
        else calendar.changeView('timeGridDay');
      }
      document.getElementById("month").style = "";
      document.getElementById("4day").style = "";
      document.getElementById(id).style = "background-color: #000; color: #fff";
    }


    let nowloading = 0;

    function edit_todo() {
      let flag = 0;
      nowloading++;
      let xhr = new XMLHttpRequest();
      xhr.open('GET', GAS_URL + "?c=true");
      xhr.onload = () => {
        calendar.removeAllEvents();
        document.getElementById("todo").innerHTML = "";

        _token.get((token) => {
          let xhr = new XMLHttpRequest();
          xhr.open('GET', 'https://content-sheets.googleapis.com/v4/spreadsheets/' + SHEET_ID + '/values/subject!A3%3AO?key=' + API_KEY);
          xhr.setRequestHeader('Authorization', 'Bearer ' + token);
          xhr.onload = () => {
            flag++
          };
          xhr.send();

          let xhr2 = new XMLHttpRequest(), flag = false;
          xhr2.open('GET', 'https://content-sheets.googleapis.com/v4/spreadsheets/' + SHEET_ID + '/values/ToDo!A2%3AH?key=' + API_KEY);
          xhr2.setRequestHeader('Authorization', 'Bearer ' + token);
          xhr2.onload = () => {
            flag++;
          };
          xhr2.send();

          let xhr3 = new XMLHttpRequest();
          xhr3.open('GET', 'https://content-sheets.googleapis.com/v4/spreadsheets/' + SHEET_ID + '/values/daily!A2%3AC?key=' + API_KEY);
          xhr3.setRequestHeader('Authorization', 'Bearer ' + token);
          xhr3.onload = () => {
            let timerId = setInterval(() => {
              if (flag === 2) {
                clearInterval(timerId);
                nowloading--;
                if (nowloading === 0) {
                  make_todo(JSON.parse(xhr2.response).values, JSON.parse(xhr3.response).values);
                  let data = JSON.parse(xhr.response).values;
                  for (var i = 0; i < 14; i++) {
                    let time_str = data[i][13].length === 4 ? "0" + data[i][13] : data[i][13];
                    let offset = new Date(today().toDateString());
                    offset.setDate(offset.getDate() + i);
                    let start = new Date(offset.toLocaleDateString() + " 09:00");
                    if (time_str === "") time_str = "18:00";
                    let end = new Date(offset.toLocaleDateString() + " " + time_str);
                    if (start.toTimeString() !== end.toTimeString()) {
                      calendar.addEvent({
                        title: (data[i][12] === "TRUE") ? "学校" : "学校+東進着",
                        start: start,
                        end: end,
                        color: "#696969",
                        editable: true,
                        startEditable: false,
                        eventStartEditable: false,
                        durationEditable: true,
                        display: 'block'
                      });
                      for (var i = 0; i < holiday.length; i++) {
                        calendar.addEvent(holiday[i]);
                      }
                    }
                  }
                }
              }
            }, 10);
          };
          xhr3.send();
        });
      };
      xhr.send();

    }

  </script>
</body>

</html>
